<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>登录 - MaskBid</title>
    <link rel="stylesheet" href="./css/layui.css">
    <link rel="stylesheet" href="./css/global.css">
</head>

<body>
<script src="./layui.js"></script>
<script src="./js/jquery.js"></script>
<script src="./js/global.js"></script>
<div class="container login">
    <div class="content first-content">
        <div class="first-column">
            <h2 class="title title-primary">欢迎回来!</h2>
            <p class="description description-primary">请准备您的登陆密钥文件</p>
            <p class="description description-primary">点击登录按钮上传即可登录系统</p>
            <button id="signin" class="btn btn-primary">登录</button>
        </div>
        <div class="second-column">
            <h2 class="title title-second">创建账户</h2>

            <form class="form layui-form">
                <div class="layui-form-item signupAccountName">
                    <label class="label-input" for="">
                        <i class="far fa-user icon-modify"></i>
                        <input type="text" placeholder="账户名称" name="newAccountName" lay-verify="required|maxLengthName">
                    </label>
                </div>
                <div class="layui-form-item signupAccountRole">
                    <input type="radio" name="newAccountRole" value="0" title="招标者" checked>
                    <input type="radio" name="newAccountRole" value="1" title="投标者">
                </div>
                <div class="layui-form-item">
                    <button id="signup" class="btn btn-second" lay-submit lay-filter="signup">注册</button>
                </div>
            </form>

        </div>
        <i class="layui-icon layui-icon-set" id="loginSettingButton" onclick="openSetting()"></i>
    </div>
</div>
<!-- 区块链设置弹出框 -->
<div id="loginSettingBoxID" class="loginSettingBox">
    <div class="layui-card">
        <div class="layui-card-header layerMove">区块链设置</div>
        <div class="layui-card-body">
            <!-- 区块链设置 -->
            <form class="layui-form layui-form-pane" action="">
                <div class="layui-form-item">
                    <label class="layui-form-label">节点地址</label>
                    <div class="layui-input-block">
                        <input type="text" name="nodeAddress" required lay-verify="required" value="127.0.0.1"
                               autocomplete="off"
                               class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">合约地址</label>
                    <div class="layui-input-block">
                        <input type="text" name="contractAddress" required lay-verify="required"
                               value="0x4a3234be1003513b8c1765bc283f3740efd8f9de" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">主表地址</label>
                    <div class="layui-input-block">
                        <input type="text" name="tableAddress" required lay-verify="required" value="dGVuZGVyVGVzdDMw"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item loginSettingPostButton">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="loginSetting">修改</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    layui.use(['element', 'layer', 'util'], function () {
        var element = layui.element
            , layer = layui.layer
            , util = layui.util
            , $ = layui.$;
    });
    //检测是否已经登录
    let jsonData = {"act": "cookies"};
    sendJson(jsonData, callbackCookies);

    function callbackCookies(json) {
        console.log(json);
        if (json.code == 0) {
            if (json.data.accountRole == "0")
                window.location.replace("./tender.html");
            else
                window.location.replace("./bidder.html");
        }
    }

    //登录
    layui.use('upload', function () {
        var upload = layui.upload;
        var uploadInst = upload.render({
            elem: '#signin'
            , url: '/signin'
            , accept: 'file'
            , exts: 'mbk'
            , done: function (res, index, upload) {
                console.log(res);
                if (res.code == 0 && res.data.loginResult) {
                    if (res.data.accountRole == "0")
                        window.location.replace("./tender.html");
                    else
                        window.location.replace("./bidder.html");
                } else {
                    alert(res.msg);
                }
            }
            , error: function (index, upload) {
                console.log("error");
                console.log(index);
                console.log(upload);
            }
        });
    });
    //注册
    layui.use('form', function () {
        var form = layui.form;
        form.on('submit(signup)', function (data) {
            console.log(data.field);
            let url = "./signup?newAccountName=" + data.field.newAccountName + "&newAccountRole=" + data.field.newAccountRole;
            let fileName = ((data.field.newAccountRole == "0") ? "Tender" : "Bidder") + "_" + data.field.newAccountName + ".mbk";
            let eleLink = document.createElement('a');
            eleLink.download = fileName;
            eleLink.style.display = 'none';
            eleLink.href = url;
            // 受浏览器安全策略的因素，动态创建的元素必须添加到浏览器后才能实施点击
            document.body.appendChild(eleLink);
            // 触发点击
            eleLink.click();
            // 然后移除
            document.body.removeChild(eleLink);

            if (data.field.newAccountRole == "0")
                window.location.replace("./tender.html");
            else
                window.location.replace("./bidder.html");
            return false;
        });
        form.verify({
            maxLengthName: function (value, item) {
                var s = new String(value);
                if (s.length > 64) {
                    return '账户名称最大为64字符，当前为' + s.length + '字符';
                }
            }
        });
    });

    function openSetting() {
        let index = layer.open({
            type: 1
            , title: false
            , content: $('#loginSettingBoxID')
            , move: '.layerMove'
            , moveOut: true
            , area: '600px'
        });
        var form = layui.form;
        form.on('submit(loginSetting)', function (data) {
            console.log(data.field);
            layer.close(index);
            return false;
        });
    }

</script>
</body>

</html>